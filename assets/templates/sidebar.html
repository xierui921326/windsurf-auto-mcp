<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WindsurfAutoMcp: å¯¹è¯æ§åˆ¶</title>
    <style>
        /* CSSæ ·å¼å°†åœ¨è¿è¡Œæ—¶é€šè¿‡{{STYLES}}å ä½ç¬¦æ³¨å…¥ */
        {{STYLES}}
    </style>
</head>

<body>
    <div class="chat-app">
        <!-- å¤´éƒ¨æ ‡é¢˜ -->
        <div class="chat-header">
            <h1 class="chat-title">WindsurfAutoMcp</h1>
            <p class="chat-subtitle">å¯¹è¯æµç¨‹æ§åˆ¶</p>
        </div>

        <!-- AI æš‚åœåŸå› åŒºåŸŸ -->
        <div class="ai-reason-card">
            <div class="ai-icon">ğŸ¤–</div>
            <div class="ai-content">
                <div class="ai-title">AI æš‚åœåŸå› </div>
                <div class="ai-message">ç­‰å¾…ç”¨æˆ·ç¡®è®¤æ˜¯å¦éœ€è¦ä¿®æ”¹é€»è¾‘</div>
            </div>
        </div>

        <!-- è®¾ç½®åŒºåŸŸ -->
        <div class="settings-section">
            <div class="settings-header" onclick="toggleSettings()">
                <span>è®¾ç½®</span>
                <span class="settings-arrow" id="settingsArrow">â–¶</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <!-- API é…ç½® -->
                <div class="config-group">
                    <div class="config-title">API é…ç½®</div>
                    <div class="config-item">
                        <label>API Key</label>
                        <input type="password" class="config-input" id="apiKey" placeholder="æ™ºè°± API å¯†é’¥ï¼ˆç”¨äºæŒ‡ä»¤ä¼˜åŒ–å’Œä¸Šä¸‹æ–‡æ‘˜è¦ï¼‰">
                    </div>
                    <div class="config-item">
                        <label>æ¨¡å‹é€‰æ‹©</label>
                        <select class="config-select" id="modelSelect">
                            <option value="GLM-4.5-Flash">GLM-4.5-Flashï¼ˆå…è´¹ï¼‰</option>
                            <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label class="config-checkbox">
                            <input type="checkbox" id="enableAdditionalRules">
                            <span class="checkmark"></span>
                            å¯ç”¨è¿½åŠ è§„åˆ™
                        </label>
                    </div>
                    <div class="config-item" id="additionalRulesContainer" style="display: none;">
                        <textarea class="config-textarea" id="additionalRules" placeholder="æ¯æ¬¡å‘é€æ—¶è‡ªåŠ¨è¿½åŠ çš„å†…å®¹" style="width: 100%; max-width: 100%; box-sizing: border-box;"></textarea>
                    </div>
                    <div class="config-item">
                        <label class="config-checkbox">
                            <input type="checkbox" id="enableContextSummary">
                            <span class="checkmark"></span>
                            å¯ç”¨ä¸Šä¸‹æ–‡æ‘˜è¦ï¼ˆåŸºäºå‰3æ¡å†å²è®°å½•ï¼‰
                        </label>
                    </div>
                    <div class="config-item">
                        <label class="config-checkbox">
                            <input type="checkbox" id="autoOptimize">
                            <span class="checkmark"></span>
                            å¼€å¯åè‡ªåŠ¨ä¼˜åŒ–æŒ‡ä»¤å†å‘é€
                        </label>
                    </div>
                </div>

            </div>
        </div>

        <!-- ä¸Šä¸‹æ–‡æ‘˜è¦ -->
        <div class="context-summary" id="contextSummary" style="display: none;">
            <div class="summary-header">
                <span class="summary-title">
                    <span class="summary-icon">ğŸ“‹</span>
                    ä¸Šä¸‹æ–‡æ‘˜è¦
                </span>
                <div class="summary-actions">
                    <button class="summary-clear" onclick="clearSummary()" title="æ¸…é™¤æ‘˜è¦">æ¸…é™¤</button>
                </div>
            </div>
            <div class="summary-content" id="summaryContent">
                <!-- æ‘˜è¦å†…å®¹å°†åœ¨æœ‰å¯¹è¯å†å²ååŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-section">
            <!-- é™„ä»¶é¢„è§ˆåŒºåŸŸ -->
            <div class="attachments-preview" id="attachmentsPreview" style="display: none;">
                <div class="attachments-header">
                    <span>é™„ä»¶é¢„è§ˆ</span>
                    <button class="clear-attachments" onclick="clearAttachments()">æ¸…é™¤å…¨éƒ¨</button>
                </div>
                <div class="attachments-list" id="attachmentsList">
                    <!-- é™„ä»¶é¡¹å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>
            
            <div class="input-container">
                <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ–°æŒ‡ä»¤..." rows="4"></textarea>
            </div>
            
            <!-- æ‰€æœ‰æŒ‰é’®æ”¾åœ¨è¾“å…¥æ¡†ä¸‹æ–¹ -->
            <div class="input-bottom-actions">
                <div class="left-actions">
                    <button class="action-btn" onclick="addFile()" title="æ·»åŠ å›¾ç‰‡/æ–‡ä»¶">
                        ğŸ“
                    </button>
                    <button class="action-btn" onclick="optimizeCommand()" title="ä¼˜åŒ–æŒ‡ä»¤">
                        âœ¨
                    </button>
                </div>
                <div class="right-actions">
                    <button class="control-btn end-btn" onclick="endConversation()">ç»“æŸ</button>
                    <button class="control-btn continue-btn" onclick="continueConversation()" id="continueBtn">ç»§ç»­</button>
                </div>
            </div>
            
        </div>

        <!-- å†å²æŒ‡ä»¤ -->
        <div class="history-section">
            <div class="history-header" onclick="toggleHistory()">
                <span>å†å²æŒ‡ä»¤</span>
                <button class="history-clear" onclick="clearHistory()">æ¸…ç©º</button>
            </div>
            <div class="history-list" id="historyList">
                <!-- å†å²è®°å½•å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        // è®¾ç½®å±•å¼€/æ”¶èµ·
        function toggleSettings() {
            const content = document.getElementById('settingsContent');
            const arrow = document.getElementById('settingsArrow');
            const isOpen = content.style.display === 'block';
            
            content.style.display = isOpen ? 'none' : 'block';
            arrow.textContent = isOpen ? 'â–¶' : 'â–¼';
        }

        // è¿½åŠ è§„åˆ™å¼€å…³æ§åˆ¶
        function toggleAdditionalRules() {
            const checkbox = document.getElementById('enableAdditionalRules');
            const container = document.getElementById('additionalRulesContainer');
            
            if (checkbox.checked) {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                // æ¸…ç©ºè¿½åŠ è§„åˆ™å†…å®¹
                document.getElementById('additionalRules').value = '';
            }
            saveState();
            showSaveNotification('è¿½åŠ è§„åˆ™è®¾ç½®å·²ä¿å­˜');
        }

        // ä¸Šä¸‹æ–‡æ‘˜è¦å¼€å…³æ§åˆ¶
        function toggleContextSummary() {
            const checkbox = document.getElementById('enableContextSummary');
            const contextSummary = document.getElementById('contextSummary');
            
            if (!checkbox.checked) {
                // å¦‚æœå…³é—­æ‘˜è¦ï¼Œéšè—æ‘˜è¦åŒºåŸŸ
                contextSummary.style.display = 'none';
                // æ¸…ç©ºæ‘˜è¦å†…å®¹
                const summaryContent = document.getElementById('summaryContent');
                if (summaryContent) {
                    summaryContent.textContent = '';
                }
            } else {
                // å¦‚æœå¼€å¯æ‘˜è¦ï¼Œé‡æ–°æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤º
                checkSummaryDisplay();
            }
            saveState();
            showSaveNotification('ä¸Šä¸‹æ–‡æ‘˜è¦è®¾ç½®å·²ä¿å­˜');
        }

        // æ˜¾ç¤ºä¿å­˜æˆåŠŸé€šçŸ¥
        function showSaveNotification(message) {
            // å‘é€æ¶ˆæ¯ç»™VSCodeæ‰©å±•æ˜¾ç¤ºé€šçŸ¥
            vscode.postMessage({
                type: 'showNotification',
                message: message,
                level: 'info'
            });
        }

        // å†å²è®°å½•å±•å¼€/æ”¶èµ·
        function toggleHistory() {
            const historyList = document.getElementById('historyList');
            const isOpen = historyList.style.display === 'block';
            historyList.style.display = isOpen ? 'none' : 'block';
        }

        // ä¼˜åŒ–æŒ‡ä»¤
        function optimizeCommand() {
            const input = document.getElementById('chatInput');
            if (input.value.trim()) {
                vscode.postMessage({ 
                    type: 'optimizeCommand', 
                    command: input.value 
                });
            }
        }

        // å­˜å‚¨é™„ä»¶æ•°æ®
        let attachments = [];

        // æ•°æ®æŒä¹…åŒ–ç›¸å…³
        const STORAGE_KEY = 'windsurfAutoMcp_state';

        // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
        function saveState() {
            const chatInput = document.getElementById('chatInput');
            const summaryContent = document.getElementById('summaryContent');
            const enableAdditionalRules = document.getElementById('enableAdditionalRules');
            const enableContextSummary = document.getElementById('enableContextSummary');
            const autoOptimize = document.getElementById('autoOptimize');
            const additionalRules = document.getElementById('additionalRules');
            
            const state = {
                attachments: attachments || [],
                conversationRounds: conversationRounds || 0,
                conversationHistory: conversationHistory || [],
                chatInput: chatInput?.value || '',
                summaryContent: summaryContent?.textContent || '',
                enableAdditionalRules: enableAdditionalRules?.checked || false,
                enableContextSummary: enableContextSummary?.checked || false,
                autoOptimize: autoOptimize?.checked || false,
                additionalRules: additionalRules?.value || '',
                timestamp: Date.now()
            };
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                console.log('çŠ¶æ€å·²ä¿å­˜:', state);
            } catch (error) {
                console.warn('æ— æ³•ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨:', error);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨æ¢å¤çŠ¶æ€
        function restoreState() {
            try {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    const state = JSON.parse(savedState);
                    
                    // æ£€æŸ¥çŠ¶æ€æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
                    const isExpired = Date.now() - state.timestamp > 24 * 60 * 60 * 1000;
                    if (isExpired) {
                        localStorage.removeItem(STORAGE_KEY);
                        console.log('ä¿å­˜çš„çŠ¶æ€å·²è¿‡æœŸï¼Œå·²æ¸…é™¤');
                        return;
                    }
                    
                    // æ¢å¤é™„ä»¶
                    if (state.attachments && Array.isArray(state.attachments)) {
                        attachments = state.attachments;
                        renderAttachments();
                    }
                    
                    // æ¢å¤å¯¹è¯è½®æ¬¡å’Œå†å²
                    if (typeof state.conversationRounds === 'number') {
                        conversationRounds = state.conversationRounds;
                        console.log('æ¢å¤å¯¹è¯è½®æ¬¡:', conversationRounds);
                    }
                    if (state.conversationHistory && Array.isArray(state.conversationHistory)) {
                        conversationHistory = state.conversationHistory;
                        console.log('æ¢å¤å¯¹è¯å†å²:', conversationHistory.length, 'æ¡è®°å½•');
                    }
                    
                    // æ¢å¤è®¾ç½®å¼€å…³çŠ¶æ€
                    const enableAdditionalRules = document.getElementById('enableAdditionalRules');
                    const enableContextSummary = document.getElementById('enableContextSummary');
                    const autoOptimize = document.getElementById('autoOptimize');
                    
                    if (enableAdditionalRules && typeof state.enableAdditionalRules === 'boolean') {
                        enableAdditionalRules.checked = state.enableAdditionalRules;
                        toggleAdditionalRules();
                    }
                    if (enableContextSummary && typeof state.enableContextSummary === 'boolean') {
                        enableContextSummary.checked = state.enableContextSummary;
                    }
                    if (autoOptimize && typeof state.autoOptimize === 'boolean') {
                        autoOptimize.checked = state.autoOptimize;
                    }
                    
                    // æ¢å¤è¿½åŠ è§„åˆ™å†…å®¹
                    const additionalRules = document.getElementById('additionalRules');
                    if (additionalRules && state.additionalRules) {
                        additionalRules.value = state.additionalRules;
                    }
                    
                    // ä¸æ¢å¤è¾“å…¥æ¡†å†…å®¹ï¼Œä¿æŒè¾“å…¥æ¡†ä¸ºç©º
                    // if (state.chatInput) {
                    //     const chatInput = document.getElementById('chatInput');
                    //     if (chatInput) {
                    //         chatInput.value = state.chatInput;
                    //     }
                    // }
                    
                    // ä¸æ¢å¤æ‘˜è¦å†…å®¹ï¼Œæ‘˜è¦åº”è¯¥åŸºäºå½“å‰æŒ‡ä»¤ç”Ÿæˆ
                    // æ¸…ç©ºä»»ä½•æ—§çš„æ‘˜è¦å†…å®¹
                    const summaryContent = document.getElementById('summaryContent');
                    const contextSummary = document.getElementById('contextSummary');
                    if (summaryContent) {
                        summaryContent.textContent = '';
                    }
                    if (contextSummary) {
                        contextSummary.style.display = 'none';
                    }
                    
                    console.log('çŠ¶æ€æ¢å¤å®Œæˆ:', state);
                }
            } catch (error) {
                console.warn('æ— æ³•ä»æœ¬åœ°å­˜å‚¨æ¢å¤çŠ¶æ€:', error);
                localStorage.removeItem(STORAGE_KEY);
            }
        }

        // æ¸…é™¤ä¿å­˜çš„çŠ¶æ€
        function clearSavedState() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (error) {
                console.warn('æ— æ³•æ¸…é™¤ä¿å­˜çš„çŠ¶æ€:', error);
            }
        }

        // æ·»åŠ æ–‡ä»¶
        function addFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = 'image/*,text/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.json,.js,.ts,.html,.css,.md';
            
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                handleFiles(files);
            };
            
            input.click();
        }

        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            files.forEach(file => {
                const reader = new FileReader();
                
                if (file.type.startsWith('image/')) {
                    reader.onload = function(e) {
                        const attachment = {
                            id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result,
                            mimeType: file.type
                        };
                        attachments.push(attachment);
                        renderAttachments();
                        saveState();
                    };
                    reader.readAsDataURL(file);
                } else {
                    reader.onload = function(e) {
                        const attachment = {
                            id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: file.name,
                            type: 'file',
                            size: file.size,
                            data: e.target.result,
                            mimeType: file.type
                        };
                        attachments.push(attachment);
                        renderAttachments();
                        saveState();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // æ·»åŠ é™„ä»¶åˆ°é¢„è§ˆåŒºåŸŸ
        function addAttachment(file) {
            const attachmentId = Date.now() + Math.random();
            const attachment = {
                id: attachmentId,
                name: file.name,
                type: file.type,
                size: file.size,
                data: file.data || file.path
            };
            
            attachments.push(attachment);
            renderAttachments();
            saveState(); // ç«‹å³ä¿å­˜çŠ¶æ€
        }

        // æ¸²æŸ“é™„ä»¶åˆ—è¡¨
        function renderAttachments() {
            const attachmentsList = document.getElementById('attachmentsList');
            const attachmentsPreview = document.getElementById('attachmentsPreview');
            
            if (attachments.length === 0) {
                attachmentsPreview.style.display = 'none';
                return;
            }
            
            attachmentsPreview.style.display = 'block';
            attachmentsList.innerHTML = '';
            
            attachments.forEach(attachment => {
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                attachmentItem.innerHTML = `
                    <div class="attachment-preview">
                        ${getAttachmentPreview(attachment)}
                    </div>
                    <div class="attachment-info">
                        <div class="attachment-name">${attachment.name}</div>
                        <div class="attachment-size">${formatFileSize(attachment.size)}</div>
                    </div>
                    <button class="attachment-remove" onclick="removeAttachment('${attachment.id}')" title="ç§»é™¤">
                        Ã—
                    </button>
                `;
                attachmentsList.appendChild(attachmentItem);
            });
        }

        // è·å–é™„ä»¶é¢„è§ˆå†…å®¹
        function getAttachmentPreview(attachment) {
            if (attachment.type && attachment.type.startsWith('image/')) {
                return `<img src="${attachment.data}" alt="${attachment.name}" class="attachment-thumbnail" onclick="viewFullImage('${attachment.data}', '${attachment.name}')" style="cursor: pointer;" title="ç‚¹å‡»æŸ¥çœ‹åŸå›¾">`;
            } else {
                // æ ¹æ®æ–‡ä»¶æ‰©å±•åæ˜¾ç¤ºä¸åŒå›¾æ ‡
                const ext = attachment.name.split('.').pop().toLowerCase();
                const icon = getFileIcon(ext);
                return `<div class="file-icon">${icon}</div>`;
            }
        }

        // æŸ¥çœ‹åŸå›¾åŠŸèƒ½
        function viewFullImage(imageSrc, imageName) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.id = 'imageModal';
            modal.innerHTML = `
                <div class="image-modal-content">
                    <div class="image-modal-header">
                        <span class="image-modal-title">${imageName}</span>
                        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
                    </div>
                    <div class="image-modal-body">
                        <img src="${imageSrc}" alt="${imageName}" class="image-modal-img">
                    </div>
                </div>
                <div class="image-modal-backdrop" onclick="closeImageModal()"></div>
            `;
            
            document.body.appendChild(modal);
        }

        // å…³é—­å›¾ç‰‡æ¨¡æ€æ¡†
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(ext) {
            const icons = {
                'pdf': 'ğŸ“„',
                'doc': 'ğŸ“', 'docx': 'ğŸ“',
                'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š',
                'ppt': 'ğŸ“ˆ', 'pptx': 'ğŸ“ˆ',
                'txt': 'ğŸ“„',
                'js': 'ğŸ“œ', 'ts': 'ğŸ“œ',
                'html': 'ğŸŒ', 'css': 'ğŸ¨',
                'json': 'ğŸ“‹',
                'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦',
                'mp4': 'ğŸ¥', 'avi': 'ğŸ¥',
                'mp3': 'ğŸµ', 'wav': 'ğŸµ'
            };
            return icons[ext] || 'ğŸ“';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ç§»é™¤é™„ä»¶
        function removeAttachment(attachmentId) {
            attachments = attachments.filter(att => att.id !== attachmentId);
            renderAttachments();
            saveState(); // ç«‹å³ä¿å­˜çŠ¶æ€
        }

        // æ¸…é™¤æ‰€æœ‰é™„ä»¶
        function clearAttachments() {
            attachments = [];
            renderAttachments();
            saveState(); // ç«‹å³ä¿å­˜çŠ¶æ€
        }

        // ç»“æŸå¯¹è¯
        function endConversation() {
            vscode.postMessage({ type: 'endConversation' });
        }

        // ç»§ç»­å¯¹è¯
        function continueConversation() {
            const input = document.getElementById('chatInput');
            let command = input.value.trim();
            const continueBtn = document.getElementById('continueBtn');
            
            if (command || attachments.length > 0) {
                // ä¿å­˜åŸå§‹æŒ‡ä»¤ç”¨äºå†å²è®°å½•
                const originalCommand = input.value.trim();
                
                // å¢åŠ å¯¹è¯è½®æ¬¡
                conversationRounds++;
                
                // æ·»åŠ åˆ°å¯¹è¯å†å²ï¼ˆåªä¿å­˜åŸå§‹æŒ‡ä»¤ï¼‰
                if (originalCommand) {
                    addToConversationHistory(originalCommand, 'user');
                    // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä»¥ä¾¿æŒä¹…åŒ–
                    saveCommandToHistory(originalCommand, 'user');
                    // åŸºäºå½“å‰æŒ‡ä»¤ç”Ÿæˆä¸Šä¸‹æ–‡æ‘˜è¦
                    generateContextSummary(originalCommand);
                }
                
                // ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                clearAttachments();
                
                // åˆ‡æ¢åˆ°å¤„ç†ä¸­çŠ¶æ€
                continueBtn.textContent = 'å¤„ç†ä¸­';
                continueBtn.disabled = true;
                continueBtn.classList.add('processing');
                
                vscode.postMessage({ 
                    type: 'continueConversation', 
                    command: originalCommand,
                    attachments: attachments,
                    conversationRounds: conversationRounds
                });
                
                // ä¿å­˜çŠ¶æ€
                saveState();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ‘˜è¦
                checkSummaryDisplay();
            }
        }

        // é‡ç½®ç»§ç»­æŒ‰é’®çŠ¶æ€
        function resetContinueButton() {
            const continueBtn = document.getElementById('continueBtn');
            continueBtn.textContent = 'ç»§ç»­';
            continueBtn.disabled = false;
            continueBtn.classList.remove('processing');
        }

        // å¯¹è¯è½®æ¬¡è®¡æ•°å™¨
        let conversationRounds = 0;
        let conversationHistory = [];

        // æ¸…é™¤æ‘˜è¦
        function clearSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const contextSummary = document.getElementById('contextSummary');
            
            if (summaryContent) {
                summaryContent.textContent = '';
            }
            if (contextSummary) {
                contextSummary.style.display = 'none';
            }
            
            // ä¿å­˜æ¸…é™¤çŠ¶æ€
            saveState();
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ‘˜è¦
        function checkSummaryDisplay() {
            const contextSummary = document.getElementById('contextSummary');
            const summaryContent = document.getElementById('summaryContent');
            const enableContextSummary = document.getElementById('enableContextSummary');
            
            // åªæœ‰åœ¨å¼€å¯æ‘˜è¦å¼€å…³ä¸”æœ‰è¶³å¤Ÿå†å²è®°å½•æ—¶æ‰æ˜¾ç¤º
            if (enableContextSummary && enableContextSummary.checked &&
                conversationHistory && conversationHistory.length >= 3 && 
                summaryContent && summaryContent.textContent.trim()) {
                contextSummary.style.display = 'block';
            } else {
                // é»˜è®¤éšè—æ‘˜è¦
                contextSummary.style.display = 'none';
            }
        }

        // åŸºäºå‰3æ¡å†å²è®°å½•ç”Ÿæˆä¸Šä¸‹æ–‡æ‘˜è¦
        function generateContextSummary(command) {
            const enableContextSummary = document.getElementById('enableContextSummary');
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨æ‘˜è¦åŠŸèƒ½
            if (!enableContextSummary || !enableContextSummary.checked) {
                return;
            }

            if (!command || !command.trim()) {
                return;
            }

            const summaryContent = document.getElementById('summaryContent');
            const contextSummary = document.getElementById('contextSummary');
            
            if (!summaryContent || !contextSummary) {
                return;
            }

            // è·å–æœ€è¿‘çš„3æ¡å†å²è®°å½•
            let recentHistory = [];
            if (conversationHistory && conversationHistory.length > 0) {
                recentHistory = conversationHistory.slice(-3);
            }

            // ç”ŸæˆåŸºäºå†å²è®°å½•çš„æ‘˜è¦
            let summary = '';
            if (recentHistory.length >= 3) {
                const historyText = recentHistory.map(h => h.content.substring(0, 30)).join(' â†’ ');
                summary = `å†å²ä»»åŠ¡: ${historyText}`;
            }

            // æ·»åŠ å½“å‰ä»»åŠ¡
            const cmd = command.toLowerCase().trim();
            let currentTask = '';
            if (cmd.includes('åˆ†æ') || cmd.includes('analyze')) {
                currentTask = `æ­£åœ¨åˆ†æï¼š${command.length > 50 ? command.substring(0, 50) + '...' : command}`;
            } else if (cmd.includes('ä¿®æ”¹') || cmd.includes('ä¿®å¤') || cmd.includes('fix')) {
                currentTask = `æ­£åœ¨ä¿®æ”¹ï¼š${command.length > 50 ? command.substring(0, 50) + '...' : command}`;
            } else if (cmd.includes('åˆ›å»º') || cmd.includes('æ–°å»º') || cmd.includes('create')) {
                currentTask = `æ­£åœ¨åˆ›å»ºï¼š${command.length > 50 ? command.substring(0, 50) + '...' : command}`;
            } else if (cmd.includes('åˆ é™¤') || cmd.includes('ç§»é™¤') || cmd.includes('delete')) {
                currentTask = `æ­£åœ¨åˆ é™¤ï¼š${command.length > 50 ? command.substring(0, 50) + '...' : command}`;
            } else if (cmd.includes('ä¼˜åŒ–') || cmd.includes('æ”¹è¿›') || cmd.includes('optimize')) {
                currentTask = `æ­£åœ¨ä¼˜åŒ–ï¼š${command.length > 50 ? command.substring(0, 50) + '...' : command}`;
            } else {
                currentTask = `å½“å‰ä»»åŠ¡ï¼š${command.length > 50 ? command.substring(0, 50) + '...' : command}`;
            }

            if (summary) {
                summary += `\n${currentTask}`;
            } else {
                summary = currentTask;
            }
            
            // è®¾ç½®æ‘˜è¦å†…å®¹å¹¶æ˜¾ç¤º
            summaryContent.textContent = summary;
            checkSummaryDisplay();
        }

        // æ·»åŠ å¯¹è¯åˆ°å†å²è®°å½•
        function addToConversationHistory(message, type = 'user') {
            const now = Date.now();
            const last = conversationHistory.length > 0 ? conversationHistory[conversationHistory.length - 1] : null;
            if (last && last.content === message && (now - last.timestamp) < 5000) {
                if (type === 'cascade' && last.type !== 'cascade') {
                    last.type = 'cascade';
                }
                return;
            }

            conversationHistory.push({
                type: type,
                content: message,
                timestamp: now
            });
            
            // ä¿æŒæœ€è¿‘50æ¡å¯¹è¯å†å²
            if (conversationHistory.length > 50) {
                conversationHistory = conversationHistory.slice(-50);
            }
            
            // ç«‹å³æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
            loadHistoryData();
        }

        // é‡ç½®ç»§ç»­æŒ‰é’®çŠ¶æ€ï¼ˆç”±å¤–éƒ¨è°ƒç”¨ï¼‰
        function resetContinueButtonFromMessage() {
            resetContinueButton();
        }

        // å¤„ç†å¯¹è¯å¼€å§‹äº‹ä»¶
        function handleConversationStarted() {
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) {
                continueBtn.textContent = 'å‘é€ä¸­';
                continueBtn.disabled = true;
                continueBtn.classList.add('processing');
            }
        }
        
        // å¤„ç†æŒ‡ä»¤å·²å‘é€äº‹ä»¶
        function handleConversationSent(message) {
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) {
                continueBtn.textContent = 'Cascadeå¤„ç†ä¸­';
                continueBtn.disabled = true;
                continueBtn.classList.add('processing');
            }
            
            // æ˜¾ç¤ºçŠ¶æ€æç¤º
            showStatusMessage('æŒ‡ä»¤å·²å‘é€ï¼Œç­‰å¾…Cascadeå¤„ç†...', 'info');
        }
        
        // å¤„ç†å¯¹è¯é”™è¯¯äº‹ä»¶
        function handleConversationError(message) {
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) {
                continueBtn.textContent = 'ç»§ç»­';
                continueBtn.disabled = false;
                continueBtn.classList.remove('processing');
            }
            
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            showStatusMessage(message.error || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
        
        // å¤„ç†Cascadeå¤„ç†ä¸­äº‹ä»¶
        function handleCascadeProcessing() {
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) {
                continueBtn.textContent = 'Cascadeå¤„ç†ä¸­';
                continueBtn.disabled = true;
                continueBtn.classList.add('processing');
            }
        }
        
        // å¤„ç†Cascadeå¤„ç†å®Œæˆäº‹ä»¶
        function handleCascadeComplete() {
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) {
                continueBtn.textContent = 'ç»§ç»­';
                continueBtn.disabled = false;
                continueBtn.classList.remove('processing');
            }
            
            // æ˜¾ç¤ºå®Œæˆæç¤º
            showStatusMessage('Cascadeå¤„ç†å®Œæˆï¼Œå¯ä»¥ç»§ç»­è¾“å…¥æ–°æŒ‡ä»¤', 'success');
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatusMessage(message, type = 'info') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            
            const colors = {
                info: '#2196F3',
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800'
            };
            
            statusDiv.style.cssText = `
                background: ${colors[type] || colors.info};
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                margin: 8px 0;
                font-size: 12px;
                text-align: center;
                animation: slideIn 0.3s ease-out;
            `;
            
            const inputSection = document.querySelector('.input-section');
            inputSection.insertBefore(statusDiv, inputSection.firstChild);
            
            // 3ç§’åç§»é™¤æç¤º
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 3000);
        }

        // å†å²è®°å½•å±•å¼€/æ”¶èµ·
        function toggleHistory() {
            const historyList = document.getElementById('historyList');
            const isOpen = historyList.style.display === 'block';
            historyList.style.display = isOpen ? 'none' : 'block';
            
            // å¦‚æœæ‰“å¼€å†å²è®°å½•ï¼ŒåŠ è½½å®é™…æ•°æ®
            if (!isOpen) {
                loadHistoryData();
            }
        }
        
        // åŠ è½½å†å²è®°å½•æ•°æ®
        function loadHistoryData() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            historyList.innerHTML = '';
            
            // æ˜¾ç¤ºå¯¹è¯å†å²
            if (conversationHistory && conversationHistory.length > 0) {
                // æŒ‰æ—¶é—´å€’åºæ˜¾ç¤ºæœ€è¿‘çš„è®°å½•
                const recentHistory = conversationHistory.slice().reverse();
                
                recentHistory.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-command-item';
                    
                    const timeStr = new Date(item.timestamp).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    // æˆªæ–­è¿‡é•¿çš„æŒ‡ä»¤å†…å®¹ç”¨äºæ˜¾ç¤º
                    const displayContent = item.content.length > 80 ? item.content.substring(0, 80) + '...' : item.content;
                    
                    // åˆ›å»ºå†å²é¡¹å…ƒç´ 
                    const commandLine = document.createElement('div');
                    commandLine.className = 'command-single-line';
                    commandLine.title = item.content; // å®Œæ•´å†…å®¹ä½œä¸ºtooltip
                    
                    // ä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨è€Œä¸æ˜¯onclickå±æ€§ï¼Œé¿å…å­—ç¬¦è½¬ä¹‰é—®é¢˜
                    commandLine.addEventListener('click', function(event) {
                        console.log('å†å²æŒ‡ä»¤è¢«ç‚¹å‡»:', {
                            content: item.content,
                            displayContent: displayContent,
                            timestamp: item.timestamp,
                            event: event
                        });
                        
                        // é˜»æ­¢äº‹ä»¶å†’æ³¡
                        event.stopPropagation();
                        
                        putCommandToInput(item.content);
                    });
                    
                    commandLine.innerHTML = `
                        <div class="command-content">${displayContent}</div>
                        <div class="command-time">${timeStr}</div>
                    `;
                    
                    historyItem.appendChild(commandLine);
                    
                    historyList.appendChild(historyItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'history-empty';
                emptyItem.innerHTML = `
                    <div class="empty-text">æš‚æ— å†å²æŒ‡ä»¤</div>
                    <div class="empty-hint">å¼€å§‹ä¸€æ¬¡å¯¹è¯åï¼ŒæŒ‡ä»¤å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                `;
                historyList.appendChild(emptyItem);
            }
        }

        
        // å°†æŒ‡ä»¤æ”¾å…¥è¾“å…¥æ¡†
        function putCommandToInput(command) {
            console.log('putCommandToInput è¢«è°ƒç”¨ï¼ŒæŒ‡ä»¤å†…å®¹:', command);
            
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                // æ¸…ç©ºç°æœ‰å†…å®¹
                chatInput.value = '';
                
                // è®¾ç½®æ–°å†…å®¹
                chatInput.value = command;
                
                // èšç„¦åˆ°è¾“å…¥æ¡†
                chatInput.focus();
                
                // å°†å…‰æ ‡ç§»åˆ°æœ«å°¾
                chatInput.setSelectionRange(command.length, command.length);
                
                console.log('æŒ‡ä»¤å·²æˆåŠŸæ”¾å…¥è¾“å…¥æ¡†:', chatInput.value);
            } else {
                console.error('æ‰¾ä¸åˆ°chatInputå…ƒç´ ');
            }
        }

        // é‡æ”¾æŒ‡ä»¤ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        function replayCommand(command) {
            putCommandToInput(command);
        }
        
        


        // æ¸…ç©ºå†å²
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                conversationHistory = [];
                conversationRounds = 0;
                
                // æ¸…ç©ºæœ¬åœ°å­˜å‚¨ä¸­çš„å†å²è®°å½•
                try {
                    localStorage.removeItem('windsurfAutoMcp_commandHistory');
                } catch (error) {
                    console.warn('æ¸…ç©ºæœ¬åœ°å†å²è®°å½•å¤±è´¥:', error);
                }
                
                saveState();
                loadHistoryData();
                showStatusMessage('å†å²è®°å½•å·²æ¸…ç©º', 'success');
            }
        }
        
        // ä¿å­˜æŒ‡ä»¤åˆ°å†å²è®°å½•
        function saveCommandToHistory(command, type = 'user') {
            try {
                const historyKey = 'windsurfAutoMcp_commandHistory';
                let commandHistory = [];
                
                const saved = localStorage.getItem(historyKey);
                if (saved) {
                    commandHistory = JSON.parse(saved);
                }
                
                const historyItem = {
                    command: command,
                    type: type,
                    timestamp: Date.now(),
                    success: true
                };

                const last = commandHistory.length > 0 ? commandHistory[commandHistory.length - 1] : null;
                if (last && last.command === command && (historyItem.timestamp - last.timestamp) < 5000) {
                    if (type === 'cascade' && last.type !== 'cascade') {
                        last.type = 'cascade';
                    }
                    localStorage.setItem(historyKey, JSON.stringify(commandHistory));
                    return;
                }

                commandHistory.push(historyItem);
                
                // ä¿æŒæœ€è¿‘100æ¡è®°å½•
                if (commandHistory.length > 100) {
                    commandHistory = commandHistory.slice(-100);
                }
                
                localStorage.setItem(historyKey, JSON.stringify(commandHistory));
            } catch (error) {
                console.warn('ä¿å­˜æŒ‡ä»¤å†å²å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æŒä¹…åŒ–çš„æŒ‡ä»¤å†å²
        function loadPersistedHistory() {
            try {
                const historyKey = 'windsurfAutoMcp_commandHistory';
                const saved = localStorage.getItem(historyKey);
                if (saved) {
                    const commandHistory = JSON.parse(saved);
                    // å°†æŒä¹…åŒ–çš„å†å²åˆå¹¶åˆ°å½“å‰å¯¹è¯å†å²ä¸­
                    commandHistory.forEach(item => {
                        if (!conversationHistory.find(h => h.timestamp === item.timestamp)) {
                            conversationHistory.push({
                                type: item.type,
                                content: item.command,
                                timestamp: item.timestamp
                            });
                        }
                    });
                    
                    // æŒ‰æ—¶é—´æ’åº
                    conversationHistory.sort((a, b) => a.timestamp - b.timestamp);
                    
                    // ä¿æŒæœ€è¿‘100æ¡
                    if (conversationHistory.length > 100) {
                        conversationHistory = conversationHistory.slice(-100);
                    }
                }
            } catch (error) {
                console.warn('åŠ è½½æŒä¹…åŒ–å†å²å¤±è´¥:', error);
            }
        }

        // ç§»é™¤äº†é”®ç›˜å¿«æ·é”®åŠŸèƒ½ï¼Œå›è½¦é”®ç°åœ¨åªç”¨äºæ¢è¡Œ
        // åªæœ‰ç‚¹å‡»ç»§ç»­æŒ‰é’®æ‰ä¼šå‘é€æŒ‡ä»¤

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const config = {
                apiKey: document.getElementById('apiKey').value,
                model: document.getElementById('modelSelect').value,
                additionalRules: document.getElementById('additionalRules').value,
                autoOptimize: document.getElementById('autoOptimize').checked
            };
            
            vscode.postMessage({ 
                type: 'saveConfig', 
                config: config 
            });
        }

        // ç›‘å¬æ¥è‡ªVSCodeçš„æ¶ˆæ¯
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'fileSelected':
                    if (message.file) {
                        addAttachment(message.file);
                    }
                    break;
                case 'summaryGenerated':
                    if (message.summary) {
                        const summaryContent = document.getElementById('summaryContent');
                        const generateBtn = document.querySelector('.summary-generate');
                        
                        summaryContent.textContent = message.summary;
                        generateBtn.textContent = 'ğŸ”„';
                        generateBtn.disabled = false;
                        
                        // ç¡®ä¿æ‘˜è¦åŒºåŸŸæ˜¾ç¤º
                        document.getElementById('contextSummary').style.display = 'block';
                        
                        // ä¿å­˜æ‘˜è¦å†…å®¹
                        saveState();
                    }
                    break;
                case 'summaryError':
                    if (message.error) {
                        const summaryContent = document.getElementById('summaryContent');
                        const generateBtn = document.querySelector('.summary-generate');
                        
                        summaryContent.textContent = message.error;
                        generateBtn.textContent = 'ğŸ”„';
                        generateBtn.disabled = false;
                    }
                    break;
                case 'optimizeStatus':
                    handleOptimizeStatus(message);
                    break;
                case 'optimizeResult':
                    handleOptimizeResult(message);
                    break;
                case 'conversationStarted':
                    // Cascadeå¼€å§‹å¤„ç†ï¼Œè®¾ç½®æŒ‰é’®ä¸ºå¤„ç†ä¸­çŠ¶æ€
                    handleConversationStarted();
                    break;
                case 'conversationSent':
                    // æŒ‡ä»¤å·²å‘é€ï¼Œç­‰å¾…Cascadeå¤„ç†
                    handleConversationSent(message);
                    break;
                case 'conversationError':
                    // å‘é€å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                    handleConversationError(message);
                    break;
                case 'cascadeProcessing':
                    // Cascadeæ­£åœ¨å¤„ç†
                    handleCascadeProcessing();
                    break;
                case 'cascadeProcessingComplete':
                    // Cascadeå¤„ç†å®Œæˆ
                    handleCascadeComplete();
                    break;
                case 'resetButtonState':
                    // é‡ç½®æŒ‰é’®çŠ¶æ€
                    resetContinueButtonFromMessage();
                    break;
                case 'addCommandToHistory':
                    // æ·»åŠ CascadeæŒ‡ä»¤åˆ°å†å²è®°å½•
                    if (message.command && message.command.trim()) {
                        console.log('æ”¶åˆ°CascadeæŒ‡ä»¤è®°å½•è¯·æ±‚:', message.command);
                        addToConversationHistory(message.command.trim(), message.source || 'cascade');
                        saveCommandToHistory(message.command.trim(), message.source || 'cascade');
                        loadHistoryData(); // ç«‹å³åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
                        console.log('CascadeæŒ‡ä»¤å·²è®°å½•åˆ°å†å²å¹¶åˆ·æ–°æ˜¾ç¤º:', message.command);
                    }
                    break;
            }
        });

        // å¤„ç†ä¼˜åŒ–çŠ¶æ€
        function handleOptimizeStatus(message) {
            const optimizeBtn = document.querySelector('.action-btn[onclick="optimizeCommand()"]');
            if (message.status === 'optimizing') {
                optimizeBtn.textContent = 'â³';
                optimizeBtn.disabled = true;
                optimizeBtn.title = message.message;
            } else if (message.status === 'error') {
                optimizeBtn.textContent = 'âœ¨';
                optimizeBtn.disabled = false;
                optimizeBtn.title = 'ä¼˜åŒ–æŒ‡ä»¤';
                // å¯ä»¥æ˜¾ç¤ºé”™è¯¯æç¤º
            }
        }

        // å¤„ç†ä¼˜åŒ–ç»“æœ
        function handleOptimizeResult(message) {
            const optimizeBtn = document.querySelector('.action-btn[onclick="optimizeCommand()"]');
            const chatInput = document.getElementById('chatInput');
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            optimizeBtn.textContent = 'âœ¨';
            optimizeBtn.disabled = false;
            optimizeBtn.title = 'ä¼˜åŒ–æŒ‡ä»¤';
            
            // å°†ä¼˜åŒ–åçš„æŒ‡ä»¤å¡«å…¥è¾“å…¥æ¡†
            if (message.optimized && chatInput) {
                chatInput.value = message.optimized;
                chatInput.focus();
                
                // æ˜¾ç¤ºä¼˜åŒ–æç¤º
                showOptimizeNotification(message.original, message.optimized);
            }
        }

        // æ˜¾ç¤ºä¼˜åŒ–æç¤º
        function showOptimizeNotification(original, optimized) {
            // åˆ›å»ºä¼˜åŒ–æç¤ºæ¡†
            const notification = document.createElement('div');
            notification.className = 'optimize-notification';
            notification.innerHTML = `
                <div class="optimize-notification-content">
                    <div class="optimize-notification-header">
                        <span>âœ¨ æŒ‡ä»¤å·²ä¼˜åŒ–</span>
                        <button class="optimize-notification-close" onclick="closeOptimizeNotification()">&times;</button>
                    </div>
                    <div class="optimize-notification-body">
                        <div class="optimize-comparison">
                            <div class="optimize-original">
                                <strong>åŸå§‹æŒ‡ä»¤ï¼š</strong>
                                <div class="optimize-text">${original}</div>
                            </div>
                            <div class="optimize-optimized">
                                <strong>ä¼˜åŒ–åï¼š</strong>
                                <div class="optimize-text">${optimized}</div>
                            </div>
                        </div>
                        <div class="optimize-actions">
                            <button class="optimize-accept" onclick="acceptOptimization()">ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬</button>
                            <button class="optimize-revert" onclick="revertOptimization('${original}')">æ¢å¤åŸç‰ˆæœ¬</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // æ·»åŠ æ ·å¼
            if (!document.getElementById('optimizeNotificationStyles')) {
                const style = document.createElement('style');
                style.id = 'optimizeNotificationStyles';
                style.textContent = `
                    .optimize-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 9999;
                        background: var(--vscode-notifications-background);
                        border: 1px solid var(--vscode-notifications-border);
                        border-radius: 6px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                        max-width: 400px;
                        animation: slideIn 0.3s ease-out;
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    
                    .optimize-notification-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 16px;
                        background: var(--vscode-notifications-foreground);
                        color: var(--vscode-notifications-background);
                        border-radius: 6px 6px 0 0;
                        font-weight: 500;
                    }
                    
                    .optimize-notification-close {
                        background: none;
                        border: none;
                        color: inherit;
                        font-size: 18px;
                        cursor: pointer;
                        padding: 0;
                        width: 20px;
                        height: 20px;
                    }
                    
                    .optimize-notification-body {
                        padding: 16px;
                    }
                    
                    .optimize-comparison {
                        margin-bottom: 16px;
                    }
                    
                    .optimize-original, .optimize-optimized {
                        margin-bottom: 12px;
                    }
                    
                    .optimize-text {
                        background: var(--vscode-input-background);
                        border: 1px solid var(--vscode-input-border);
                        border-radius: 4px;
                        padding: 8px;
                        margin-top: 4px;
                        font-size: 12px;
                        color: var(--vscode-input-foreground);
                        max-height: 60px;
                        overflow-y: auto;
                    }
                    
                    .optimize-actions {
                        display: flex;
                        gap: 8px;
                    }
                    
                    .optimize-accept, .optimize-revert {
                        flex: 1;
                        padding: 6px 12px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                        transition: background-color 0.2s;
                    }
                    
                    .optimize-accept {
                        background: var(--vscode-button-background);
                        color: var(--vscode-button-foreground);
                    }
                    
                    .optimize-accept:hover {
                        background: var(--vscode-button-hoverBackground);
                    }
                    
                    .optimize-revert {
                        background: var(--vscode-button-secondaryBackground);
                        color: var(--vscode-button-secondaryForeground);
                    }
                    
                    .optimize-revert:hover {
                        background: var(--vscode-button-secondaryHoverBackground);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 5ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                closeOptimizeNotification();
            }, 5000);
        }

        // å…³é—­ä¼˜åŒ–æç¤º
        function closeOptimizeNotification() {
            const notification = document.querySelector('.optimize-notification');
            if (notification) {
                notification.remove();
            }
        }

        // æ¥å—ä¼˜åŒ–
        function acceptOptimization() {
            closeOptimizeNotification();
        }

        // æ¢å¤åŸç‰ˆæœ¬
        function revertOptimization(original) {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = original;
                chatInput.focus();
            }
            closeOptimizeNotification();
        }

        // ç›‘å¬é…ç½®å˜åŒ–
        ['apiKey', 'modelSelect', 'additionalRules', 'autoOptimize'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                if (id === 'apiKey') {
                    // API Key ä½¿ç”¨å®æ—¶ä¿å­˜
                    element.addEventListener('input', debounce(saveConfig, 1000));
                    element.addEventListener('blur', saveConfig);
                } else {
                    element.addEventListener('change', saveConfig);
                }
            }
        });

        // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹ä¿å­˜
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        function setupDragAndDrop() {
            const chatApp = document.querySelector('.chat-app');
            const chatInput = document.getElementById('chatInput');
            
            // é˜²æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                chatApp.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // é«˜äº®æ‹–æ‹½åŒºåŸŸ
            ['dragenter', 'dragover'].forEach(eventName => {
                chatApp.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                chatApp.addEventListener(eventName, unhighlight, false);
            });
            
            // å¤„ç†æ–‡ä»¶æ‹–æ‹½
            chatApp.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                chatApp.classList.add('drag-over');
            }
            
            function unhighlight(e) {
                chatApp.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = Array.from(dt.files);
                
                if (files.length > 0) {
                    handleFiles(files);
                }
            }
        }

        // è®¾ç½®ç²˜è´´åŠŸèƒ½
        function setupPasteHandler() {
            const chatInput = document.getElementById('chatInput');
            
            chatInput.addEventListener('paste', function(e) {
                const items = Array.from(e.clipboardData.items);
                const files = [];
                
                items.forEach(item => {
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        if (file) {
                            files.push(file);
                        }
                    }
                });
                
                if (files.length > 0) {
                    e.preventDefault();
                    handleFiles(files);
                }
            });
        }

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // æ¢å¤çŠ¶æ€
            restoreState();
            
            // åŠ è½½å†å²æ•°æ®
            loadHistoryData();
            
            // æ˜¾ç¤ºå†å²åˆ—è¡¨
            const historyList = document.getElementById('historyList');
            if (historyList) {
                historyList.style.display = 'block';
            }
            
            // æ£€æŸ¥æ‘˜è¦æ˜¾ç¤º
            checkSummaryDisplay();
            
            // æ·»åŠ æ‹–æ‹½å’Œç²˜è´´äº‹ä»¶ç›‘å¬å™¨
            setupDragAndDrop();
            setupPasteHandler();
            
            // æ·»åŠ è®¾ç½®å¼€å…³äº‹ä»¶ç›‘å¬å™¨
            const enableAdditionalRules = document.getElementById('enableAdditionalRules');
            const enableContextSummary = document.getElementById('enableContextSummary');
            const autoOptimize = document.getElementById('autoOptimize');
            const additionalRules = document.getElementById('additionalRules');
            
            if (enableAdditionalRules) {
                enableAdditionalRules.addEventListener('change', toggleAdditionalRules);
            }
            if (enableContextSummary) {
                enableContextSummary.addEventListener('change', toggleContextSummary);
            }
            if (autoOptimize) {
                autoOptimize.addEventListener('change', saveState);
            }
            
            // ä¸ºè¿½åŠ è§„åˆ™æ·»åŠ å®æ—¶ä¿å­˜
            if (additionalRules) {
                additionalRules.addEventListener('input', debounce(saveState, 500));
                additionalRules.addEventListener('blur', saveState);
            }
            
            // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’ï¼‰
            setInterval(saveState, 30000);
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        });

        // é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€
        window.addEventListener('beforeunload', function() {
            saveState();
        });

        // é¡µé¢éšè—æ—¶ä¿å­˜çŠ¶æ€ï¼ˆç”¨äºå¤„ç†æ ‡ç­¾é¡µåˆ‡æ¢ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                saveState();
            }
        });
        
        // çª—å£å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜çŠ¶æ€
        window.addEventListener('blur', function() {
            saveState();
        });
        
        // ç›‘å¬VSCodeæ‰©å±•é‡å¯äº‹ä»¶
        window.addEventListener('message', function(event) {
            if (event.data.type === 'extensionRestarting') {
                saveState();
            }
        });
    </script>
</body>

</html>